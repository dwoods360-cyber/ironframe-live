datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --- AGENT WORKFORCE ENUMS ---
enum RiskTier {
  CRITICAL
  HIGH
  MED
  LOW
}

enum AgentStatus {
  ONLINE
  OFFLINE
  THINKING
  ERROR
}

// ------------------------------------------------------
// TENANT (Constitutional - Multi-tenant identity / routing)
// ------------------------------------------------------
model Tenant {
  id           BigInt   @id @default(autoincrement())
  name         String
  slug         String   @unique
  industry     String   @default("Secure Enclave")
  ale_baseline BigInt   @default(0) // ALE math must use BigInt

  // Relationships for Phase 4 Workflows
  vendors    Vendor[]
  agent_logs AgentLog[]
  createdAt  DateTime @default(now())

  @@map("tenants")
}

// ------------------------------------------------------
// THE TENANT BOUNDARY (The Client Organizations)
// ------------------------------------------------------
model Company {
  id                       BigInt       @id @default(autoincrement())
  name                     String
  sector                    String
  industry_avg_loss_cents  BigInt?      // Refactored: Stored in exact cents
  infrastructure_val_cents BigInt?      // Refactored: Stored in exact cents

  departments Department[]
  policies    Policy[]
  risks      ActiveRisk[]

  @@map("companies")
}

// ------------------------------------------------------
// INTERNAL DIVISIONS
// ------------------------------------------------------
model Department {
  id         BigInt   @id @default(autoincrement())
  company_id BigInt
  name       String   // e.g., "IT", "Finance", "HR"
  
  company    Company  @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@map("departments")
}

// ------------------------------------------------------
// THE AGENT WORKFORCE TARGETS
// ------------------------------------------------------
model Policy {
  id         BigInt   @id @default(autoincrement())
  company_id BigInt
  name       String
  status     String   // 'COMPLIANT' or 'GAP DETECTED'
  last_scan  String   @default("Today")
  
  company    Company  @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@map("policies")
}

model ActiveRisk {
  id         BigInt   @id @default(autoincrement())
  company_id BigInt
  title      String
  status     String
  score      Float
  source     String   // e.g., 'IronSight', 'CoreIntel'
  
  company    Company  @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@map("active_risks")
}

// ------------------------------------------------------
// SUPPLY CHAIN (TPRM / VRM) - Tenant-scoped
// ------------------------------------------------------
model Vendor {
  id        String  @id @default(uuid())
  name      String
  riskTier  String  @default("LOW") // CRITICAL, HIGH, MEDIUM, LOW
  tenantId  BigInt
  tenant    Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("vendors")
}

// ------------------------------------------------------
// AGENT LOGS (Phase 4 Workflows)
// ------------------------------------------------------
model AgentLog {
  id        String   @id @default(uuid())
  timestamp DateTime @default(now())
  message   String
  tenantId  BigInt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("agent_logs")
}

/// Agent 1: Ironcore - Persistence & Self-Healing Registry
model Failed_Jobs {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id   String   @db.Uuid
  job_type    String
  payload     Json
  error_state Json
  retry_count Int      @default(0)
  status      String   @default("pending")
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@index([tenant_id])
  @@index([status])
}

/// Agent 16: Ironscout - Task TTL & Ad-hoc Tracking
model Ironscout_Tasks {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id   String   @db.Uuid
  target_url  String
  directive   String
  status      String   @default("active")
  created_at  DateTime @default(now())
  expires_at  DateTime // Strictly 0.50 - 71.75 hr per TAS

  @@index([tenant_id])
  @@index([expires_at])
}