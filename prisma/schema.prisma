datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --- AGENT WORKFORCE ENUMS ---
enum RiskTier {
  CRITICAL
  HIGH
  MED
  LOW
}

enum AgentStatus {
  ONLINE
  OFFLINE
  THINKING
  ERROR
}

// ------------------------------------------------------
// TENANT (Constitutional - Standardized to UUID for RLS)
// ------------------------------------------------------
model Tenant {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String
  slug         String   @unique
  industry     String   @default("Secure Enclave")
  ale_baseline BigInt   @default(0) // ALE math remains BigInt cents

  vendors    Vendor[]
  agent_logs AgentLog[]
  createdAt  DateTime @default(now())

  @@map("tenants")
}

// ------------------------------------------------------
// THE TENANT BOUNDARY (Standardized to BigInt for high-count scale)
// ------------------------------------------------------
model Company {
  id                       BigInt   @id @default(autoincrement())
  name                     String
  sector                   String
  industry_avg_loss_cents  BigInt?  // BIGINT Cents
  infrastructure_val_cents BigInt?  // BIGINT Cents

  departments Department[]
  policies    Policy[]
  risks       ActiveRisk[]

  @@map("companies")
}

model Department {
  id         BigInt @id @default(autoincrement())
  company_id BigInt
  name       String

  company    Company @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@map("departments")
}

model Policy {
  id         BigInt @id @default(autoincrement())
  company_id BigInt
  name       String
  status     String
  last_scan  String @default("Today")

  company    Company @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@map("policies")
}

model ActiveRisk {
  id          BigInt @id @default(autoincrement())
  company_id  BigInt
  title       String
  status      String
  score_cents BigInt // REFACTORED: Unified to BIGINT cents
  source      String

  company    Company @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@map("active_risks")
}

// ------------------------------------------------------
// SUPPLY CHAIN (Standardized to UUID to match Tenant)
// ------------------------------------------------------
model Vendor {
  id        String @id @default(uuid())
  name      String
  riskTier  String @default("LOW")
  tenantId  String @db.Uuid
  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("vendors")
}

model AgentLog {
  id        String   @id @default(uuid())
  timestamp DateTime @default(now())
  message   String
  tenantId  String   @db.Uuid
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("agent_logs")
}

// ------------------------------------------------------
// SOVEREIGN AGENT MODELS
// ------------------------------------------------------

/// Agent 1: Ironcore - Persistence & Self-Healing Registry
model Failed_Jobs {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id   String   @db.Uuid
  job_type    String
  payload     Json
  error_state Json
  retry_count Int      @default(0)
  status      String   @default("pending")
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@index([tenant_id])
  @@index([status])
}

/// Agent 16: Ironscout - Task TTL & Ad-hoc Tracking
model Ironscout_Tasks {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id   String   @db.Uuid
  target_url  String
  directive   String
  status      String   @default("active")
  created_at  DateTime @default(now())
  expires_at  DateTime

  @@index([tenant_id])
  @@index([expires_at])
}
